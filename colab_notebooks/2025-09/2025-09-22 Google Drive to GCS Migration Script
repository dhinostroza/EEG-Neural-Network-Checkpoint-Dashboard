{"cells":[{"cell_type":"code","source":["# -*- coding: utf-8 -*-\n","\"\"\"\n","This script migrates files from a specified Google Drive folder to a\n","Google Cloud Storage (GCS) bucket.\n","\n","It's designed to be run in a Google Colab environment.\n","\"\"\"\n","\n","import os\n","from google.colab import auth\n","from google.colab import drive\n","from google.cloud import storage\n","\n","# --- 1. User Authentication ---\n","# This command will prompt you to authenticate with your Google account.\n","# This single authentication will grant access to both Google Drive and GCS\n","# for the project associated with your Colab environment.\n","print(\"Authenticating user...\")\n","auth.authenticate_user()\n","print(\"Authentication successful.\")\n","\n","# --- 2. Mount Google Drive ---\n","# This makes your Google Drive files accessible within the Colab file system\n","# at the path '/content/drive'.\n","print(\"Mounting Google Drive...\")\n","try:\n","    drive.mount('/content/drive', force_remount=True)\n","    print(\"Google Drive mounted successfully at /content/drive.\")\n","except Exception as e:\n","    print(f\"Error mounting Google Drive: {e}\")\n","    # Exit if drive mounting fails\n","    exit()\n","\n","# --- 3. Configuration (PLEASE EDIT THESE VALUES FOR EACH RUN) ---\n","# Your Google Cloud project ID.\n","GCP_PROJECT_ID = \"shhs-sleepedfx\"\n","\n","# The name of your GCS bucket.\n","GCS_BUCKET_NAME = \"shhs-sleepedfx-data-bucket\"\n","\n","# The path to the folder in your Google Drive you want to migrate.\n","# This path is relative to \"My Drive\".\n","# --- CHANGE THIS VALUE FOR EACH FOLDER ---\n","# 1st run: \"shhs1_processed\"\n","# 2nd run: \"shhs2_processed\"\n","# 3rd run: \"sleep_edfx_processed\"\n","DRIVE_FOLDER_PATH = \"sleep_edfx_processed\"\n","\n","# (Optional) Specify a destination folder within your GCS bucket.\n","# We will place each Drive folder into a matching folder in the bucket.\n","GCS_DESTINATION_PREFIX = DRIVE_FOLDER_PATH\n","\n","# --- 4. Initialize GCS Client ---\n","try:\n","    storage_client = storage.Client(project=GCP_PROJECT_ID)\n","    bucket = storage_client.get_bucket(GCS_BUCKET_NAME)\n","    print(f\"Successfully connected to GCS bucket: '{GCS_BUCKET_NAME}'\")\n","except Exception as e:\n","    print(f\"Error connecting to GCS bucket. Please check your project ID and bucket name.\")\n","    print(f\"Details: {e}\")\n","    exit()\n","\n","# --- 5. File Migration Logic ---\n","# Construct the full source path in the mounted Drive.\n","full_drive_path = os.path.join('/content/drive/MyDrive', DRIVE_FOLDER_PATH)\n","\n","if not os.path.isdir(full_drive_path):\n","    print(f\"ERROR: The specified Google Drive folder does not exist: {full_drive_path}\")\n","    exit()\n","\n","print(\"\\nStarting file migration...\")\n","print(f\"Source:      '{full_drive_path}'\")\n","print(f\"Destination: 'gs://{GCS_BUCKET_NAME}/{GCS_DESTINATION_PREFIX}/'\")\n","print(\"-\" * 40)\n","\n","total_files_migrated = 0\n","total_files_failed = 0\n","total_files_skipped = 0 # Counter for skipped files\n","\n","try:\n","    # os.walk recursively goes through the directory tree.\n","    for dirpath, _, filenames in os.walk(full_drive_path):\n","        for filename in filenames:\n","            # Full path of the source file\n","            local_path = os.path.join(dirpath, filename)\n","\n","            # Create a relative path to maintain the folder structure in GCS\n","            relative_path = os.path.relpath(local_path, full_drive_path)\n","\n","            # Construct the destination path (blob name) in GCS\n","            # This will place files inside a folder matching the source folder name\n","            gcs_blob_name = os.path.join(GCS_DESTINATION_PREFIX, relative_path)\n","\n","            # --- Check if file already exists in GCS ---\n","            blob = bucket.blob(gcs_blob_name)\n","            if blob.exists():\n","                print(f\"  [SKIPPED] '{relative_path}' already exists in GCS. Skipping.\")\n","                total_files_skipped += 1\n","                continue # Skip to the next file if it exists\n","\n","            try:\n","                # Upload the file if it doesn't exist\n","                blob.upload_from_filename(local_path)\n","                print(f\"  [SUCCESS] Migrated '{relative_path}'\")\n","                total_files_migrated += 1\n","            except Exception as e:\n","                print(f\"  [FAILED]  Could not upload '{relative_path}'. Error: {e}\")\n","                total_files_failed += 1\n","\n","finally:\n","    # --- 6. Unmount Google Drive ---\n","    # It's good practice to unmount the drive when done.\n","    drive.flush_and_unmount()\n","    print(\"\\nGoogle Drive unmounted.\")\n","\n","print(\"\\n--- Migration Summary ---\")\n","print(f\"Folder migrated: '{DRIVE_FOLDER_PATH}'\")\n","print(f\"Total files successfully migrated: {total_files_migrated}\")\n","print(f\"Total files failed to migrate: {total_files_failed}\")\n","print(f\"Total files skipped (already in GCS): {total_files_skipped}\") # Print skipped count\n","print(\"Migration process complete for this folder.\")"],"outputs":[{"output_type":"stream","name":"stdout","text":["Authenticating user...\n","Authentication successful.\n","Mounting Google Drive...\n","Mounted at /content/drive\n","Google Drive mounted successfully at /content/drive.\n","Successfully connected to GCS bucket: 'shhs-sleepedfx-data-bucket'\n","\n","Starting file migration...\n","Source:      '/content/drive/MyDrive/sleep_edfx_processed'\n","Destination: 'gs://shhs-sleepedfx-data-bucket/sleep_edfx_processed/'\n","----------------------------------------\n","  [SUCCESS] Migrated 'SC4002E.parquet'\n","  [SUCCESS] Migrated 'SC4012E.parquet'\n","  [SUCCESS] Migrated 'SC4001E.parquet'\n","  [SUCCESS] Migrated 'SC4011E.parquet'\n","  [SUCCESS] Migrated 'SC4021E.parquet'\n","  [SUCCESS] Migrated 'SC4022E.parquet'\n","  [SUCCESS] Migrated 'SC4031E.parquet'\n","  [SUCCESS] Migrated 'SC4032E.parquet'\n","  [SUCCESS] Migrated 'SC4041E.parquet'\n","  [SUCCESS] Migrated 'SC4042E.parquet'\n","  [SUCCESS] Migrated 'SC4051E.parquet'\n","  [SUCCESS] Migrated 'SC4052E.parquet'\n","  [SUCCESS] Migrated 'SC4061E.parquet'\n","  [SUCCESS] Migrated 'SC4062E.parquet'\n","  [SUCCESS] Migrated 'SC4071E.parquet'\n","  [SUCCESS] Migrated 'SC4072E.parquet'\n","  [SUCCESS] Migrated 'SC4081E.parquet'\n","  [SUCCESS] Migrated 'SC4082E.parquet'\n","  [SUCCESS] Migrated 'SC4091E.parquet'\n","  [SUCCESS] Migrated 'SC4092E.parquet'\n","  [SUCCESS] Migrated 'SC4101E.parquet'\n","  [SUCCESS] Migrated 'SC4102E.parquet'\n","  [SUCCESS] Migrated 'SC4111E.parquet'\n","  [SUCCESS] Migrated 'SC4112E.parquet'\n","  [SUCCESS] Migrated 'SC4121E.parquet'\n","  [SUCCESS] Migrated 'SC4122E.parquet'\n","  [SUCCESS] Migrated 'SC4131E.parquet'\n","  [SUCCESS] Migrated 'SC4141E.parquet'\n","  [SUCCESS] Migrated 'SC4142E.parquet'\n","  [SUCCESS] Migrated 'SC4151E.parquet'\n","  [SUCCESS] Migrated 'SC4152E.parquet'\n","  [SUCCESS] Migrated 'SC4161E.parquet'\n","  [SUCCESS] Migrated 'SC4162E.parquet'\n","  [SUCCESS] Migrated 'SC4171E.parquet'\n","  [SUCCESS] Migrated 'SC4172E.parquet'\n","  [SUCCESS] Migrated 'SC4181E.parquet'\n","  [SUCCESS] Migrated 'SC4182E.parquet'\n","  [SUCCESS] Migrated 'SC4191E.parquet'\n","  [SUCCESS] Migrated 'SC4192E.parquet'\n","  [SUCCESS] Migrated 'SC4201E.parquet'\n","  [SUCCESS] Migrated 'SC4202E.parquet'\n","  [SUCCESS] Migrated 'SC4211E.parquet'\n","  [SUCCESS] Migrated 'SC4212E.parquet'\n","  [SUCCESS] Migrated 'SC4221E.parquet'\n","  [SUCCESS] Migrated 'SC4222E.parquet'\n","  [SUCCESS] Migrated 'SC4231E.parquet'\n","  [SUCCESS] Migrated 'SC4232E.parquet'\n","  [SUCCESS] Migrated 'SC4241E.parquet'\n","  [SUCCESS] Migrated 'SC4242E.parquet'\n","  [SUCCESS] Migrated 'SC4251E.parquet'\n","  [SUCCESS] Migrated 'SC4252E.parquet'\n","  [SUCCESS] Migrated 'SC4261F.parquet'\n","  [SUCCESS] Migrated 'SC4262F.parquet'\n","  [SUCCESS] Migrated 'SC4271F.parquet'\n","  [SUCCESS] Migrated 'SC4272F.parquet'\n","  [SUCCESS] Migrated 'SC4281G.parquet'\n","  [SUCCESS] Migrated 'SC4282G.parquet'\n","  [SUCCESS] Migrated 'SC4291G.parquet'\n","  [SUCCESS] Migrated 'SC4292G.parquet'\n","  [SUCCESS] Migrated 'SC4301E.parquet'\n","  [SUCCESS] Migrated 'SC4302E.parquet'\n","  [SUCCESS] Migrated 'SC4311E.parquet'\n","  [SUCCESS] Migrated 'SC4312E.parquet'\n","  [SUCCESS] Migrated 'SC4321E.parquet'\n","  [SUCCESS] Migrated 'SC4322E.parquet'\n","  [SUCCESS] Migrated 'SC4331F.parquet'\n","  [SUCCESS] Migrated 'SC4332F.parquet'\n","  [SUCCESS] Migrated 'SC4341F.parquet'\n","  [SUCCESS] Migrated 'SC4342F.parquet'\n","  [SUCCESS] Migrated 'SC4351F.parquet'\n","  [SUCCESS] Migrated 'SC4352F.parquet'\n","  [SUCCESS] Migrated 'SC4362F.parquet'\n","  [SUCCESS] Migrated 'SC4371F.parquet'\n","  [SUCCESS] Migrated 'SC4372F.parquet'\n","  [SUCCESS] Migrated 'SC4381F.parquet'\n","  [SUCCESS] Migrated 'SC4382F.parquet'\n","  [SUCCESS] Migrated 'SC4401E.parquet'\n","  [SUCCESS] Migrated 'SC4402E.parquet'\n","  [SUCCESS] Migrated 'SC4411E.parquet'\n","  [SUCCESS] Migrated 'SC4412E.parquet'\n","  [SUCCESS] Migrated 'SC4421E.parquet'\n","  [SUCCESS] Migrated 'SC4422E.parquet'\n","  [SUCCESS] Migrated 'SC4431E.parquet'\n","  [SUCCESS] Migrated 'SC4432E.parquet'\n","  [SUCCESS] Migrated 'SC4441E.parquet'\n","  [SUCCESS] Migrated 'SC4442E.parquet'\n","  [SUCCESS] Migrated 'SC4451F.parquet'\n","  [SUCCESS] Migrated 'SC4452F.parquet'\n","  [SUCCESS] Migrated 'SC4461F.parquet'\n","  [SUCCESS] Migrated 'SC4462F.parquet'\n","  [SUCCESS] Migrated 'SC4471F.parquet'\n","  [SUCCESS] Migrated 'SC4472F.parquet'\n","  [SUCCESS] Migrated 'SC4481F.parquet'\n","  [SUCCESS] Migrated 'SC4482F.parquet'\n","  [SUCCESS] Migrated 'SC4491G.parquet'\n","  [SUCCESS] Migrated 'SC4492G.parquet'\n","  [SUCCESS] Migrated 'SC4501E.parquet'\n","  [SUCCESS] Migrated 'SC4502E.parquet'\n","  [SUCCESS] Migrated 'SC4511E.parquet'\n","  [SUCCESS] Migrated 'SC4512E.parquet'\n","  [SUCCESS] Migrated 'SC4522E.parquet'\n","  [SUCCESS] Migrated 'SC4531E.parquet'\n","  [SUCCESS] Migrated 'SC4532E.parquet'\n","  [SUCCESS] Migrated 'SC4541F.parquet'\n","  [SUCCESS] Migrated 'SC4542F.parquet'\n","  [SUCCESS] Migrated 'SC4551F.parquet'\n","  [SUCCESS] Migrated 'SC4552F.parquet'\n","  [SUCCESS] Migrated 'SC4561F.parquet'\n","  [SUCCESS] Migrated 'SC4562F.parquet'\n","  [SUCCESS] Migrated 'SC4571F.parquet'\n","  [SUCCESS] Migrated 'SC4572F.parquet'\n","  [SUCCESS] Migrated 'SC4581G.parquet'\n","  [SUCCESS] Migrated 'SC4582G.parquet'\n","  [SUCCESS] Migrated 'SC4591G.parquet'\n","  [SUCCESS] Migrated 'SC4592G.parquet'\n","  [SUCCESS] Migrated 'SC4601E.parquet'\n","  [SUCCESS] Migrated 'SC4602E.parquet'\n","  [SUCCESS] Migrated 'SC4611E.parquet'\n","  [SUCCESS] Migrated 'SC4612E.parquet'\n","  [SUCCESS] Migrated 'SC4621E.parquet'\n","  [SUCCESS] Migrated 'SC4622E.parquet'\n","  [SUCCESS] Migrated 'SC4631E.parquet'\n","  [SUCCESS] Migrated 'SC4632E.parquet'\n","  [SUCCESS] Migrated 'SC4641E.parquet'\n","  [SUCCESS] Migrated 'SC4642E.parquet'\n","  [SUCCESS] Migrated 'SC4651E.parquet'\n","  [SUCCESS] Migrated 'SC4652E.parquet'\n","  [SUCCESS] Migrated 'SC4661E.parquet'\n","  [SUCCESS] Migrated 'SC4662E.parquet'\n","  [SUCCESS] Migrated 'SC4671G.parquet'\n","  [SUCCESS] Migrated 'SC4672G.parquet'\n","  [SUCCESS] Migrated 'SC4701E.parquet'\n","  [SUCCESS] Migrated 'SC4702E.parquet'\n","  [SUCCESS] Migrated 'SC4711E.parquet'\n","  [SUCCESS] Migrated 'SC4712E.parquet'\n","  [SUCCESS] Migrated 'SC4721E.parquet'\n","  [SUCCESS] Migrated 'SC4722E.parquet'\n","  [SUCCESS] Migrated 'SC4731E.parquet'\n","  [SUCCESS] Migrated 'SC4732E.parquet'\n","  [SUCCESS] Migrated 'SC4741E.parquet'\n","  [SUCCESS] Migrated 'SC4742E.parquet'\n","  [SUCCESS] Migrated 'SC4751E.parquet'\n","  [SUCCESS] Migrated 'SC4752E.parquet'\n","  [SUCCESS] Migrated 'SC4761E.parquet'\n","  [SUCCESS] Migrated 'SC4762E.parquet'\n","  [SUCCESS] Migrated 'SC4771G.parquet'\n","  [SUCCESS] Migrated 'SC4772G.parquet'\n","  [SUCCESS] Migrated 'SC4801G.parquet'\n","  [SUCCESS] Migrated 'SC4802G.parquet'\n","  [SUCCESS] Migrated 'SC4811G.parquet'\n","  [SUCCESS] Migrated 'SC4812G.parquet'\n","  [SUCCESS] Migrated 'SC4821G.parquet'\n","  [SUCCESS] Migrated 'SC4822G.parquet'\n","  [SUCCESS] Migrated 'ST7011J.parquet'\n","  [SUCCESS] Migrated 'ST7012J.parquet'\n","  [SUCCESS] Migrated 'ST7021J.parquet'\n","  [SUCCESS] Migrated 'ST7022J.parquet'\n","  [SUCCESS] Migrated 'ST7041J.parquet'\n","  [SUCCESS] Migrated 'ST7042J.parquet'\n","  [SUCCESS] Migrated 'ST7051J.parquet'\n","  [SUCCESS] Migrated 'ST7052J.parquet'\n","  [SUCCESS] Migrated 'ST7061J.parquet'\n","  [SUCCESS] Migrated 'ST7062J.parquet'\n","  [SUCCESS] Migrated 'ST7071J.parquet'\n","  [SUCCESS] Migrated 'ST7072J.parquet'\n","  [SUCCESS] Migrated 'ST7081J.parquet'\n","  [SUCCESS] Migrated 'ST7082J.parquet'\n","  [SUCCESS] Migrated 'ST7091J.parquet'\n","  [SUCCESS] Migrated 'ST7092J.parquet'\n","  [SUCCESS] Migrated 'ST7101J.parquet'\n","  [SUCCESS] Migrated 'ST7102J.parquet'\n","  [SUCCESS] Migrated 'ST7111J.parquet'\n","  [SUCCESS] Migrated 'ST7112J.parquet'\n","  [SUCCESS] Migrated 'ST7121J.parquet'\n","  [SUCCESS] Migrated 'ST7122J.parquet'\n","  [SUCCESS] Migrated 'ST7131J.parquet'\n","  [SUCCESS] Migrated 'ST7132J.parquet'\n","  [SUCCESS] Migrated 'ST7141J.parquet'\n","  [SUCCESS] Migrated 'ST7142J.parquet'\n","  [SUCCESS] Migrated 'ST7151J.parquet'\n","  [SUCCESS] Migrated 'ST7152J.parquet'\n","  [SUCCESS] Migrated 'ST7161J.parquet'\n","  [SUCCESS] Migrated 'ST7162J.parquet'\n","  [SUCCESS] Migrated 'ST7171J.parquet'\n","  [SUCCESS] Migrated 'ST7172J.parquet'\n","  [SUCCESS] Migrated 'ST7181J.parquet'\n","  [SUCCESS] Migrated 'ST7182J.parquet'\n","  [SUCCESS] Migrated 'ST7191J.parquet'\n","  [SUCCESS] Migrated 'ST7192J.parquet'\n","  [SUCCESS] Migrated 'ST7201J.parquet'\n","  [SUCCESS] Migrated 'ST7202J.parquet'\n","  [SUCCESS] Migrated 'ST7211J.parquet'\n","  [SUCCESS] Migrated 'ST7212J.parquet'\n","  [SUCCESS] Migrated 'ST7221J.parquet'\n","  [SUCCESS] Migrated 'ST7222J.parquet'\n","  [SUCCESS] Migrated 'ST7241J.parquet'\n","  [SUCCESS] Migrated 'ST7242J.parquet'\n","\n","Google Drive unmounted.\n","\n","--- Migration Summary ---\n","Folder migrated: 'sleep_edfx_processed'\n","Total files successfully migrated: 197\n","Total files failed to migrate: 0\n","Total files skipped (already in GCS): 0\n","Migration process complete for this folder.\n"]}],"execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Ttb6Ge_G58Jy","executionInfo":{"status":"ok","timestamp":1756008568718,"user_tz":300,"elapsed":1133135,"user":{"displayName":"Daniel Hinostroza","userId":"01416331706775365219"}},"outputId":"2cec8bab-de98-452b-bdf4-f8178507fe3a"}},{"cell_type":"code","source":["# = =============================================================================\n","# SCRIPT 1: DOWNLOAD AND UPLOAD DEPENDENCY SOURCE CODE\n","# (Run this in an environment WITH internet access, like Colab Pro+)\n","# ==============================================================================\n","import os\n","\n","# --- CONFIGURATION ---\n","GCS_BUCKET_NAME = \"shhs-sleepedfx-colab-deps\"\n","# -------------------\n","\n","# 1. Authenticate to Google Cloud\n","from google.colab import auth\n","auth.authenticate_user()\n","print(\"‚úÖ Authenticated to Google Cloud.\")\n","\n","# 2. Clear the old, incompatible packages from the GCS bucket\n","gcs_packages_path = f\"gs://{GCS_BUCKET_NAME}/packages/\"\n","print(f\"Clearing old packages from {gcs_packages_path}...\")\n","!gsutil -m rm -r {gcs_packages_path}*\n","print(\"‚úÖ Old packages cleared.\")\n","\n","# 3. Create the requirements.txt file locally\n","# We add 'build' and 'wheel' which are necessary for compiling from source\n","requirements_content = \"\"\"\n","build\n","wheel\n","pytorch-lightning\n","timm\n","pandas\n","pyarrow==19.0.0\n","gcsfs\n","mne\n","scikit-image\n","matplotlib\n","gradio\n","ray[default]\n","\"\"\"\n","with open(\"requirements.txt\", \"w\") as f:\n","    f.write(requirements_content)\n","\n","print(\"‚úÖ requirements.txt created.\")\n","\n","# 4. Create a local directory to store the downloaded source code\n","local_source_dir = \"/tmp/pip-sources\"\n","os.makedirs(local_source_dir, exist_ok=True)\n","print(f\"Created local directory: {local_source_dir}\")\n","\n","# 5. Use pip to download the source distributions and wheels for all packages\n","print(\"üöÄ Starting download of all required package source code and wheels...\")\n","# Remove --no-binary=:all: to allow wheels to be downloaded\n","!pip download -r requirements.txt -d {local_source_dir}\n","print(\"‚úÖ All packages downloaded successfully.\")\n","\n","# 6. Upload the source code and requirements file to your GCS bucket\n","print(f\"üöÄ Uploading contents of {local_source_dir} to {gcs_packages_path}...\")\n","upload_result = !gsutil -m cp -r {local_source_dir}/* {gcs_packages_path}\n","upload_requirements_result = !gsutil cp requirements.txt gs://{GCS_BUCKET_NAME}/\n","\n","if \"CommandException: No URLs matched\" in \"\\n\".join(upload_result):\n","    print(\"\\n‚ùå No source code files were uploaded to your GCS bucket because the download failed.\")\n","else:\n","    print(\"\\n‚úÖ All source code files have been successfully uploaded to your GCS bucket.\")\n","\n","if \"CommandException\" in \"\\n\".join(upload_requirements_result):\n","     print(\"‚ùå requirements.txt failed to upload.\")\n","else:\n","     print(\"‚úÖ requirements.txt has been successfully uploaded to your GCS bucket.\")\n","\n","\n","print(\"\\nMigration process complete.\")"],"metadata":{"id":"LMt6KhD3Ymyb"},"execution_count":null,"outputs":[]}],"metadata":{"colab":{"provenance":[],"machine_shape":"hm"},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}